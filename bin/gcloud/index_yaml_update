#!/usr/bin/env bash
# make bash play nicely
#
set -o pipefail -o errtrace -o errexit -o nounset
shopt -s inherit_errexit
[[ -n "${TRACE:-}" ]] && set -o xtrace

NEO4J_VERSION="${NEO4J_VERSION:?NEO4J_VERSION is required}"
# neo4j or neo4j-experimental
HELM_REPO_NAME="${HELM_REPO_NAME:?HELM_REPO_NAME is required}"
echo "sleeping for 300 seconds"
sleep 300
helm repo add neo4j "https://helm.neo4j.com/${HELM_REPO_NAME}"
helm repo update

echo "Pulling 4.x helm charts"
helm pull neo4j/neo4j-standalone --version "${NEO4J_VERSION}"
helm pull neo4j/neo4j-cluster-headless-service --version "${NEO4J_VERSION}"
helm pull neo4j/neo4j-cluster-core --version "${NEO4J_VERSION}"
helm pull neo4j/neo4j-cluster-read-replica --version "${NEO4J_VERSION}"
helm pull neo4j/neo4j-cluster-loadbalancer --version "${NEO4J_VERSION}"
helm pull neo4j/neo4j-reverse-proxy --version "${NEO4J_VERSION}"
helm pull neo4j/neo4j-admin --version "${NEO4J_VERSION}"

# index.yaml is present only in dev branch
git checkout dev
git pull
helm repo index . --merge index.yaml --url https://github.com/neo4j/helm-charts/releases/download/"${NEO4J_VERSION}"
git add index.yaml
git commit -m "Updating index.yaml with ${NEO4J_VERSION} entries"
git push